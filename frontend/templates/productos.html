{% extends "base.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="h4 mb-0">Gestión de Artesanías</h2>
  <button type="button" class="btn btn-primary" id="btn-open-add-modal">
    <i class="bi bi-plus-circle me-1"></i> Agregar Nueva Artesanía
  </button>
</div>

<!-- Modal para Agregar/Editar Producto -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <form id="form-producto">
        <div class="modal-header">
          <h5 class="modal-title" id="productModalLabel">Agregar Nueva Artesanía</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Nombre</label>
              <input class="form-control" name="nombre" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Categoría</label>
              <input class="form-control" name="categoria" required>
            </div>
            <div class="col-12">
              <label class="form-label">Descripción</label>
              <textarea class="form-control" name="descripcion" rows="2" required></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">Precio</label>
              <input class="form-control" name="precio" type="number" step="0.01" required>
            </div>
            <div class="col-md-8">
              <label class="form-label">URL de Imagen</label>
              <input class="form-control" name="image" type="url" placeholder="https://ejemplo.com/imagen.jpg">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" id="btn-submit" class="btn btn-primary">Agregar Producto</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteModalLabel">Confirmar Eliminación</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ¿Estás seguro de que quieres eliminar esta artesanía? Esta acción no se puede deshacer.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" id="btn-confirm-delete" class="btn btn-danger">Eliminar</button>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Listado</span>
    <button id="btn-refresh" class="btn btn-outline-secondary btn-sm">Actualizar</button>
  </div>
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-sm align-middle table-hover">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Categoría</th>
            <th class="text-center">Imagen</th>
            <th class="text-end">Precio</th>
            <th class="text-end">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbody-productos"></tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const form = document.getElementById('form-producto');
  const productModalEl = document.getElementById('productModal');
  const productModal = new bootstrap.Modal(productModalEl);
  const productModalLabel = document.getElementById('productModalLabel');
  const submitButton = document.getElementById('btn-submit');

  async function fetchProductos() {
    try {
      const res = await fetch(`${GATEWAY_URL}/api/v1/productos/`, {
        headers: getAuthHeaders()
      });
      if (!res.ok) {
        const errorData = await res.json();
        throw new Error(`Error al cargar productos: ${errorData.detail || res.statusText}`);
      }

      const data = await res.json();
      const tbody = document.getElementById('tbody-productos');
      tbody.innerHTML = '';

      // Verifica si la respuesta es un mensaje en lugar de una lista de productos
      if (data.message) {
        tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-muted">${data.message}</td>
        </tr>`;
        return;
      }

      // Si hay productos, mostrarlos
      const productos = Array.isArray(data) ? data : (data.items || []);

      if (productos.length === 0) {
        tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center text-muted">No hay productos disponibles</td>
        </tr>`;
        return;
      }

      productos.forEach(p => {
        const productData = JSON.stringify(p).replace(/"/g, '&quot;');
        tbody.insertAdjacentHTML('beforeend', `
        <tr id="producto-row-${p.id}">
          <td>${p.id ?? ''}</td>
          <td>${p.nombre ?? ''}</td>
          <td>${p.categoria ?? ''}</td>
          <td class="text-center">
            <img src="${p.image || 'https://placehold.co/60x60/F4F1DE/3D405B?text=N/A'}" alt="${p.nombre}" width="60" height="60" class="rounded" style="object-fit: cover;">
          </td>
          <td class="text-end">${typeof p.precio === 'number' ? formatCurrency(p.precio) : 'N/A'}</td>
          <td class="text-end">
            <button class="btn btn-sm btn-outline-secondary me-1" onclick='editProducto(${productData})'>Editar</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteProducto('${p.id}')">Eliminar</button>
          </td>
        </tr>`);
      });

    } catch (error) {
      showToast(error.message, 'danger');
    }
  }

  function editProducto(producto) {
    // Asegurarse de que el precio no tenga decimales para el input type="number"
    const precioParaInput = Math.round(producto.precio);

    form.id.value = producto.id;
    form.nombre.value = producto.nombre;
    form.categoria.value = producto.categoria;
    form.descripcion.value = producto.descripcion;
    form.precio.value = producto.precio;
    form.image.value = producto.image || '';

    productModalLabel.textContent = `Editando Artesanía #${producto.id}`;
    submitButton.textContent = 'Actualizar Producto';
    submitButton.classList.remove('btn-primary');
    submitButton.classList.add('btn-success');
    productModal.show();
  }

  function resetForm() {
    form.reset();
    form.id.value = '';
    productModalLabel.textContent = 'Agregar Nueva Artesanía';
    submitButton.textContent = 'Agregar Producto';
    submitButton.classList.remove('btn-success');
    submitButton.classList.add('btn-primary');
  }

  const deleteConfirmModalEl = document.getElementById('deleteConfirmModal');
  const deleteConfirmModal = new bootstrap.Modal(deleteConfirmModalEl);
  const confirmDeleteBtn = document.getElementById('btn-confirm-delete');

  async function deleteProducto(id) {
    // Configura el botón de confirmación para que sepa qué ID eliminar
    confirmDeleteBtn.onclick = async () => {
      const row = document.getElementById(`producto-row-${id}`);
      try {
        const response = await fetch(`${GATEWAY_URL}/api/v1/productos/${id}`, {
          method: 'DELETE', headers: getAuthHeaders()
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || 'Error al eliminar el producto');
        }
        showToast('Artesanía eliminada con éxito.', 'success');
        // Animación de desvanecimiento
        if (row) {
          row.style.transition = 'opacity 0.5s ease';
          row.style.opacity = '0';
          setTimeout(() => row.remove(), 500);
        } else {
          fetchProductos(); // Fallback si la fila no se encuentra
        }
      } catch (error) {
        showToast(error.message, 'danger');
      } finally {
        deleteConfirmModal.hide();
      }
    };
    // Muestra el modal de confirmación
    deleteConfirmModal.show();
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const id = fd.get('id');
    const payload = {
      nombre: fd.get('nombre'),
      descripcion: fd.get('descripcion'),
      categoria: fd.get('categoria'),
      precio: parseFloat(fd.get('precio')),
      image: fd.get('image') || null
    };

    const isUpdating = id !== '';
    const url = isUpdating ? `${GATEWAY_URL}/api/v1/productos/${id}` : `${GATEWAY_URL}/api/v1/productos/`;
    const method = isUpdating ? 'PUT' : 'POST';

    try {
      const res = await fetch(url, {
        method: method,
        headers: getAuthHeaders(),
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const errorData = await res.json();
        const actionText = isUpdating ? 'actualizar' : 'agregar';
        throw new Error(`Error al ${actionText} producto: ${errorData.detail || res.statusText}`);
      }
      const successMessage = isUpdating ? 'Artesanía actualizada con éxito.' : 'Artesanía agregada con éxito.';
      showToast(successMessage, 'success');
      productModal.hide();
      fetchProductos();
    } catch (error) {
      showToast(error.message, 'danger');
    }
  });

  // Limpia el formulario cuando el modal se cierra
  productModalEl.addEventListener('hidden.bs.modal', resetForm);

  // Abre el modal en modo "agregar"
  document.getElementById('btn-open-add-modal').addEventListener('click', () => {
    productModal.show();
  });

  // Alias para las funciones para que sean accesibles desde el HTML (onclick)
  window.editProducto = editProducto;
  window.deleteProducto = deleteProducto;
  document.getElementById('btn-refresh').addEventListener('click', fetchProductos);
  fetchProductos();
</script>
{% endblock %}